     1                                  ; external functions from X11 library
     2                                  extern XOpenDisplay
     3                                  extern XDisplayName
     4                                  extern XCloseDisplay
     5                                  extern XCreateSimpleWindow
     6                                  extern XMapWindow
     7                                  extern XRootWindow
     8                                  extern XSelectInput
     9                                  extern XFlush
    10                                  extern XCreateGC
    11                                  extern XSetForeground
    12                                  extern XDrawLine
    13                                  extern XDrawPoint
    14                                  extern XFillArc
    15                                  extern XNextEvent
    16                                  
    17                                  ; external functions from stdio library (ld-linux-x86-64.so.2)    
    18                                  extern printf
    19                                  extern exit
    20                                  
    21                                  %define	StructureNotifyMask	131072
    22                                  %define KeyPressMask		1
    23                                  %define ButtonPressMask		4
    24                                  %define MapNotify		19
    25                                  %define KeyPress		2
    26                                  %define ButtonPress		4
    27                                  %define Expose			12
    28                                  %define ConfigureNotify		22
    29                                  %define CreateNotify 16
    30                                  %define QWORD	8
    31                                  %define DWORD	4
    32                                  %define WORD	2
    33                                  %define BYTE	1
    34                                  
    35                                  global main
    36                                  
    37                                  %DEFINE NUM_POINTS 10
    38                                  %DEFINE MAX_X 255
    39                                  %DEFINE MAX_Y 255
    40                                  
    41                                  section .data
    42 00000000 0000000000000000-       event:		times	24 dq 0
    42 00000000 <rep 18h>          
    43                                  
    44 000000C0 00000000                x1:	dd	0
    45 000000C4 00000000                x2:	dd	0
    46 000000C8 00000000                y1:	dd	0
    47 000000CC 00000000                y2:	dd	0
    48                                  
    49 000000D0 25640A00                fmt_printf: db "%d", 10, 0
    50 000000D4 76733A2025640A00        fmt_index: db "vs: %d", 10, 0
    51 000000DC 4D696E696D756D3A20-     fmt_min: db "Minimum: %d", 10, 0
    51 000000E5 25640A00           
    52                                  
    53                                  section .bss
    54 00000000 ????????????????        display_name:	resq	1
    55 00000008 ????????                screen:		resd	1
    56 0000000C ????????                depth:         	resd	1
    57 00000010 ????????                connection:    	resd	1
    58 00000014 ????????                width:         	resd	1
    59 00000018 ????????                height:        	resd	1
    60 0000001C ????????????????        window:		resq	1
    61 00000024 ????????????????        gc:		resq	1
    62                                  
    63 0000002C <res 14h>               coordx: resw NUM_POINTS
    64 00000040 <res 14h>               coordy: resw NUM_POINTS
    65 00000054 <res 14h>               enveloppe: resw NUM_POINTS
    66 00000068 ??                      sizeEnveloppe: resb 1
    67 00000069 ????                    randnum: resw 1
    68 0000006B ????                    minpoint: resw 1
    69                                  
    70                                  ; Variables de l'algo, potentiellement à renommer
    71 0000006D ????                    P: resw 1
    72                                  
    73                                  section .text
    74                                  main:
    75                                  ; Génération des points du programme
    76 00000000 BB00000000              mov rbx, 0
    77                                  populatex:
    78 00000005 660FC7F0                    rdrand ax
    79 00000009 66890425[69000000]          mov [randnum], ax
    80                                      modx:
    81 00000011 66812C25[69000000]-             sub word[randnum], MAX_X
    81 00000019 FF00               
    82 0000001B 66813C25[69000000]-             cmp word[randnum], MAX_X
    82 00000023 FF00               
    83 00000025 73EA                            jae modx
    84 00000027 668B0425[69000000]          mov ax, word[randnum]
    85 0000002F 6689841B[2C000000]          mov word[coordx+rbx*2], ax
    86                                      
    87 00000037 48BF-                       mov rdi, fmt_printf
    87 00000039 [D000000000000000] 
    88 00000041 480FB7B41B-                 movzx rsi, word[coordx+rbx*2]
    88 00000046 [2C000000]         
    89 0000004A B800000000                  mov rax, 0
    90 0000004F E8(00000000)                call printf
    91                                      
    92 00000054 48FFC3                      inc rbx
    93 00000057 4883FB0A                    cmp rbx, NUM_POINTS
    94 0000005B 72A8                        jb populatex
    95                                      
    96 0000005D BB00000000              mov rbx, 0
    97                                  populatey:
    98 00000062 F9                          stc
    99                                      checkcf:
   100 00000063 660FC7F0                        rdrand ax
   101 00000067 73FA                        jnc checkcf
   102 00000069 66890425[69000000]          mov [randnum], ax
   103                                      mody:
   104 00000071 66812C25[69000000]-             sub word[randnum], MAX_Y
   104 00000079 FF00               
   105 0000007B 66813C25[69000000]-             cmp word[randnum], MAX_Y
   105 00000083 FF00               
   106 00000085 73EA                            jae mody
   107 00000087 668B0425[69000000]          mov ax, word[randnum]
   108 0000008F 6689841B[40000000]          mov word[coordy+rbx*2], ax
   109                                      ;########
   110 00000097 48BF-                       mov rdi, fmt_printf
   110 00000099 [D000000000000000] 
   111 000000A1 480FB7B41B-                 movzx rsi, word[coordy+rbx*2]
   111 000000A6 [40000000]         
   112 000000AA B800000000                  mov rax, 0
   113 000000AF E8(00000000)                call printf
   114                                      ;########
   115                                      
   116 000000B4 48FFC3                      inc rbx
   117 000000B7 4883FB0A                    cmp rbx, NUM_POINTS
   118 000000BB 72A5                        jb populatey
   119                                      
   120                                  ; Trouver le point le plus à gauche
   121 000000BD BB00000000              mov rbx, 0
   122 000000C2 66891C25[6B000000]      mov word[minpoint], bx
   123 000000CA 48FFC3                  inc rbx
   124                                  minAlgo:
   125                                      ; On récupère le point minimum actuel
   126 000000CD 480FB70C25-                 movzx rcx, word[minpoint]
   126 000000D2 [6B000000]         
   127 000000D6 480FB78409-                 movzx rax, word[coordx+rcx*2]
   127 000000DB [2C000000]         
   128                                      
   129                                      ; On le compare au point parcouru actuel
   130 000000DF 663B841B[2C000000]          cmp ax, word[coordx+rbx*2]
   131 000000E7 720B                        jb lower
   132                                              
   133                                      ; Si minpoint > point actuel, on mets point actuel dans minpoint
   134 000000E9 4889D8                      mov rax, rbx
   135 000000EC 66890425[6B000000]          mov word[minpoint], ax
   136                                  
   137                                      lower:
   138 000000F4 48FFC3                      inc rbx
   139 000000F7 4883FB0A                    cmp rbx, NUM_POINTS
   140 000000FB 72D0                        jb minAlgo
   141                                      
   142 000000FD 4831FF                      xor     rdi,rdi
   143 00000100 E8(00000000)            call    XOpenDisplay	; Création de display
   144 00000105 48890425[00000000]      mov     qword[display_name],rax	; rax=nom du display
   145                                  
   146                                  ; display_name structure
   147                                  ; screen = DefaultScreen(display_name);
   148 0000010D 488B0425[00000000]      mov     rax,qword[display_name]
   149 00000115 8B80E0000000            mov     eax,dword[rax+0xe0]
   150 0000011B 890425[08000000]        mov     dword[screen],eax
   151                                  
   152 00000122 488B3C25[00000000]      mov rdi,qword[display_name]
   153 0000012A 8B3425[08000000]        mov esi,dword[screen]
   154 00000131 E8(00000000)            call XRootWindow
   155 00000136 4889C3                  mov rbx,rax
   156                                  
   157 00000139 488B3C25[00000000]      mov rdi,qword[display_name]
   158 00000141 4889DE                  mov rsi,rbx
   159 00000144 BA0A000000              mov rdx,10
   160 00000149 B90A000000              mov rcx,10
   161 0000014E 41B890010000            mov r8,400	; largeur
   162 00000154 41B990010000            mov r9,400	; hauteur
   163 0000015A 68FFFFFF00              push 0xFFFFFF	; background  0xRRGGBB
   164 0000015F 6800FF0000              push 0x00FF00
   165 00000164 6A01                    push 1
   166 00000166 E8(00000000)            call XCreateSimpleWindow
   167 0000016B 48890425[1C000000]      mov qword[window],rax
   168                                  
   169 00000173 488B3C25[00000000]      mov rdi,qword[display_name]
   170 0000017B 488B3425[1C000000]      mov rsi,qword[window]
   171 00000183 BA05000200              mov rdx,131077 ;131072
   172 00000188 E8(00000000)            call XSelectInput
   173                                  
   174 0000018D 488B3C25[00000000]      mov rdi,qword[display_name]
   175 00000195 488B3425[1C000000]      mov rsi,qword[window]
   176 0000019D E8(00000000)            call XMapWindow
   177                                  
   178 000001A2 488B3425[1C000000]      mov rsi,qword[window]
   179 000001AA BA00000000              mov rdx,0
   180 000001AF B900000000              mov rcx,0
   181 000001B4 E8(00000000)            call XCreateGC
   182 000001B9 48890425[24000000]      mov qword[gc],rax
   183                                  
   184 000001C1 488B3C25[00000000]      mov rdi,qword[display_name]
   185 000001C9 488B3425[24000000]      mov rsi,qword[gc]
   186 000001D1 BA00000000              mov rdx,0x000000	; Couleur du crayon
   187 000001D6 E8(00000000)            call XSetForeground
   188                                  
   189                                  boucle: ; boucle de gestion des évènements
   190 000001DB 488B3C25[00000000]      mov rdi,qword[display_name]
   191 000001E3 48BE-                   mov rsi,event
   191 000001E5 [0000000000000000] 
   192 000001ED E8(00000000)            call XNextEvent
   193                                  
   194 000001F2 833C25[00000000]16      cmp dword[event],ConfigureNotify	; à l'apparition de la fenêtre
   195 000001FA 7410                    je dessin			; on saute au label 'dessin'
   196                                  
   197 000001FC 833C25[00000000]02      cmp dword[event],KeyPress			; Si on appuie sur une touche
   198 00000204 0F8486020000            je closeDisplay					; on saute au label 'closeDisplay' qui ferme la fenêtre
   199 0000020A EBCF                    jmp boucle
   200                                      
   201                                  ;#########################################
   202                                  ;#        DEBUT DE LA ZONE DE DESSIN     #
   203                                  ;#########################################
   204                                  dessin:
   205                                  
   206                                      ; boucle dessin point
   207                                      
   208 0000020C BB00000000                  mov rbx, 0  
   209                                      draw_point_loop:
   210                                  
   211                                          ;couleur du point 1
   212 00000211 488B3C25[00000000]              mov rdi,qword[display_name]
   213 00000219 488B3425[24000000]              mov rsi,qword[gc]
   214 00000221 BA00000000                      mov edx,0x000000	; Couleur noire
   215 00000226 E8(00000000)                    call XSetForeground
   216                                          
   217                                          ; Dessin d'un point du point
   218 0000022B 488B3C25[00000000]              mov rdi,qword[display_name]
   219 00000233 488B3425[1C000000]              mov rsi,qword[window]
   220 0000023B 488B1425[24000000]              mov rdx,qword[gc]	
   221 00000243 480FB78C1B-                     movzx rcx, word [coordx+rbx*2] ; coordonnée en x du point généré
   221 00000248 [2C000000]         
   222 0000024C 83E903                          sub ecx,3		
   223 0000024F 4C0FB7841B-                     movzx r8, word [coordy+rbx*2] ; coordonnée en y du point généré
   223 00000254 [40000000]         
   224 00000258 4983E803                        sub r8,3
   225 0000025C 41B906000000                    mov r9,6
   226 00000262 B8005A0000                      mov rax,23040
   227 00000267 50                              push rax
   228 00000268 6A00                            push 0
   229 0000026A 4151                            push r9
   230 0000026C E8(00000000)                    call XFillArc
   231                                  
   232                                          ;++loopcounter
   233 00000271 48FFC3                          inc rbx
   234                                          
   235                                          ;check if end loop
   236 00000274 4883FB0A                        cmp rbx, NUM_POINTS
   237 00000278 7297                            jb draw_point_loop
   238                                          
   239                                          
   240                                      ; boucle dessin ligne
   241                                      
   242 0000027A BB00000000                  mov rbx, 0 
   243 0000027F B800000000                  mov rax, 0 
   244                                      draw_line_loop:
   245                                  
   246                                          ;couleur de la ligne 1
   247 00000284 488B3C25[00000000]              mov rdi,qword[display_name]
   248 0000028C 488B3425[24000000]              mov rsi,qword[gc]
   249 00000294 BA00000000                      mov edx,0x000000	; Couleur du crayon ; noir
   250 00000299 E8(00000000)                    call XSetForeground
   251                                          
   252                                          ; coordonnées de la ligne 1 (noire)
   253 0000029E 0FB7841B[2C000000]              movzx eax, word [coordx+rbx*2]
   254 000002A6 890425[C0000000]                mov dword[x1],eax
   255 000002AD B800000000                      mov eax, 0
   256                                          
   257 000002B2 0FB7841B[40000000]              movzx eax, word [coordy+rbx*2]
   258 000002BA 890425[C8000000]                mov dword[y1],eax
   259 000002C1 B800000000                      mov eax, 0
   260                                          
   261 000002C6 48FFC3                          inc rbx
   262                                             
   263 000002C9 4883FB0A                        cmp rbx , NUM_POINTS
   264 000002CD 746D                            je set_draw_last_point
   265                                          
   266 000002CF 0FB7841B[2C000000]              movzx eax, word [coordx+rbx*2]
   267 000002D7 890425[C4000000]                mov dword[x2], eax
   268 000002DE B800000000                      mov eax, 0
   269                                          
   270 000002E3 0FB7841B[40000000]              movzx eax, word [coordy+rbx*2]
   271 000002EB 890425[CC000000]                mov dword[y2], eax
   272 000002F2 B800000000                      mov eax, 0
   273                                          
   274                                          ; dessin de la ligne 1
   275 000002F7 488B3C25[00000000]              mov rdi,qword[display_name]
   276 000002FF 488B3425[1C000000]              mov rsi,qword[window]
   277 00000307 488B1425[24000000]              mov rdx,qword[gc]
   278 0000030F 8B0C25[C0000000]                mov ecx,dword[x1]	; coordonnée source en x
   279 00000316 448B0425[C8000000]              mov r8d,dword[y1]	; coordonnée source en y
   280 0000031E 448B0C25[C4000000]              mov r9d,dword[x2]	; coordonnée destination en x
   281 00000326 FF3425[CC000000]                push qword[y2]		; coordonnée destination en y
   282 0000032D E8(00000000)                    call XDrawLine
   283                                          
   284                                          ;check if end loop
   285 00000332 4883FB0A                        cmp rbx, NUM_POINTS
   286 00000336 0F8248FFFFFF                    jb draw_line_loop
   287                                          
   288                                          set_draw_last_point:
   289 0000033C BB00000000                          mov rbx, 0
   290 00000341 0FB7841B[2C000000]                  movzx eax, word [coordx+rbx*2]
   291 00000349 890425[C4000000]                    mov dword[x2], eax
   292 00000350 B800000000                          mov eax, 0
   293                                              
   294 00000355 0FB7841B[40000000]                  movzx eax, word [coordy+rbx*2]
   295 0000035D 890425[CC000000]                    mov dword[y2], eax
   296 00000364 B800000000                          mov eax, 0
   297                                              
   298                                              ; dessin de la ligne 1
   299 00000369 488B3C25[00000000]                  mov rdi,qword[display_name]
   300 00000371 488B3425[1C000000]                  mov rsi,qword[window]
   301 00000379 488B1425[24000000]                  mov rdx,qword[gc]
   302 00000381 8B0C25[C0000000]                    mov ecx,dword[x1]	; coordonnée source en x
   303 00000388 448B0425[C8000000]                  mov r8d,dword[y1]	; coordonnée source en y
   304 00000390 448B0C25[C4000000]                  mov r9d,dword[x2]	; coordonnée destination en x
   305 00000398 FF3425[CC000000]                    push qword[y2]	; coordonnée destination en y
   306 0000039F E8(00000000)                        call XDrawLine
   307 000003A4 E9CE000000                          jmp flush
   308                                              
   309                                  color_point_in:
   310                                          ;mov rbx, (le point en question)
   311 000003A9 BB02000000                      mov rbx,2
   312                                          ;couleur du point 1
   313 000003AE 488B3C25[00000000]              mov rdi,qword[display_name]
   314 000003B6 488B3425[24000000]              mov rsi,qword[gc]
   315 000003BE BA00FF0000                      mov edx,0x00FF00	; Couleur vert
   316 000003C3 E8(00000000)                    call XSetForeground
   317                                          
   318                                          ; Dessin du point
   319 000003C8 488B3C25[00000000]              mov rdi,qword[display_name]
   320 000003D0 488B3425[1C000000]              mov rsi,qword[window]
   321 000003D8 488B1425[24000000]              mov rdx,qword[gc]	
   322 000003E0 480FB78C1B-                     movzx rcx, word [coordx+rbx*2] ; x
   322 000003E5 [2C000000]         
   323 000003E9 83E903                          sub ecx,3		
   324 000003EC 4C0FB7841B-                     movzx r8, word [coordy+rbx*2] ; y
   324 000003F1 [40000000]         
   325 000003F5 4983E803                        sub r8,3
   326 000003F9 41B906000000                    mov r9,6
   327 000003FF B8005A0000                      mov rax,23040
   328 00000404 50                              push rax
   329 00000405 6A00                            push 0
   330 00000407 4151                            push r9
   331 00000409 E8(00000000)                    call XFillArc
   332                                          ;jmp flush
   333                                          
   334                                  color_point_out:
   335                                          ;mov rbx, (le point en question)
   336 0000040E BB05000000                      mov rbx, 5
   337                                          ;couleur du point 1
   338 00000413 488B3C25[00000000]              mov rdi,qword[display_name]
   339 0000041B 488B3425[24000000]              mov rsi,qword[gc]
   340 00000423 BA0000FF00                      mov edx,0xFF0000	; Couleur vert
   341 00000428 E8(00000000)                    call XSetForeground
   342                                          
   343                                          ; Dessin du point
   344 0000042D 488B3C25[00000000]              mov rdi,qword[display_name]
   345 00000435 488B3425[1C000000]              mov rsi,qword[window]
   346 0000043D 488B1425[24000000]              mov rdx,qword[gc]	
   347 00000445 480FB78C1B-                     movzx rcx, word [coordx+rbx*2] ; x
   347 0000044A [2C000000]         
   348 0000044E 83E903                          sub ecx,3		
   349 00000451 4C0FB7841B-                     movzx r8, word [coordy+rbx*2] ; y
   349 00000456 [40000000]         
   350 0000045A 4983E803                        sub r8,3
   351 0000045E 41B906000000                    mov r9,6
   352 00000464 B8005A0000                      mov rax,23040
   353 00000469 50                              push rax
   354 0000046A 6A00                            push 0
   355 0000046C 4151                            push r9
   356 0000046E E8(00000000)                    call XFillArc
   357 00000473 EB02                            jmp flush
   358                                  ; ############################
   359                                  ; # FIN DE LA ZONE DE DESSIN #
   360                                  ; ############################
   361 00000475 EB00                    jmp flush
   362                                  
   363                                  flush:
   364 00000477 488B3C25[00000000]          mov rdi,qword[display_name]
   365 0000047F E8(00000000)                call XFlush
   366 00000484 E952FDFFFF                  jmp boucle
   367 00000489 B822000000                  mov rax,34
   368 0000048E 0F05                        syscall
   369                                  
   370                                  closeDisplay:
   371 00000490 488B0425[00000000]          mov     rax,qword[display_name]
   372 00000498 4889CF                      mov     rdi,rcx
   373 0000049B E8(00000000)                call    XCloseDisplay
   374 000004A0 4831FF                      xor	    rdi,rdi
   375 000004A3 E8(00000000)                call    exit	
   376                                  
   377                                  ; Une fois cette étape fini, nous connaissons le point le plus à gauche.
   378                                  ; On commence donc la marche de Jarvis
   379 000004A8 BB00000000              mov rbx, 0
   380                                  jarvis:
   381                                      
   382                                  ; Pour fermer le programme proprement :
   383 000004AD B83C000000              mov    rax, 60         
   384 000004B2 BF00000000              mov    rdi, 0
   385 000004B7 0F05                    syscall
   386                                  
   387 000004B9 C3                      ret
